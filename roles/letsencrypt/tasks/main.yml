---
# Check / renew SSL certificate with Let's Encrypt

- name: letsencrypt | request challenge
  tags:
    - ssl
  letsencrypt:
    account_email: "{{ acme_account }}"
    account_key: "{{ acme_dir }}/letsencrypt.key"
    csr: "{{ acme_dir }}/{{ acme_name }}.csr"
    dest: "{{ acme_dir }}/{{ acme_name }}.crt"
    acme_directory: "{{ acme_url }}"
    challenge: http-01
    remaining_days: 14
  register: domain_challenge

- name: letsencrypt | fulfill HTTP challenge
  tags:
    - ssl
  copy:
    dest: /var/www/html/{{ domain_challenge['challenge_data']['sample.com']['http-01']['resource'] }}
    content: "{{ domain_challenge['challenge_data']['sample.com']['http-01']['resource_value'] }}"
  when: domain_challenge | changed 

- name: letsencrypt | fulfill DNS challenge
  tags:
    - dns
  cloudflare:
    account_email: "{{ cloudflare_email }}"
    account_api_token: "{{ cloudflare_token }}"
    zone: "{{ cloudflare_zone_id }}"
    type: A
    record: "{{ inventory_hostname }}"
    value: "{{ ansible_host }}"

- name: letsencrypt | complete challenge
  tags:
    - ssl
  letsencrypt:
    account_key: _account_key.p12
    csr: _domain_csr.p12
    dest: _domain_crt.p12
    data: "{{ domain_challenge }}"
